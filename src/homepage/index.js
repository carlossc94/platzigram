var page =require('page');
var vacio=require('empty-element');
var template=require('./template');
var title=require('title');
var request=require('superagent');
var header=require('../header');
var axios=require('axios');
var Webcam=require('webcamjs');
var picture=require('../picture-cards');

page('/',header,asyncLoad,function(ctx, next){
	title('Platzigram');
	var main=document.getElementById('main-container');

//agregar a la variable main un hijo en la cual es todo lo que esta en elemen
	vacio(main).appendChild(template(ctx.pictures));

	//se agrgara las constantes en la cual se agregara la funcionalidad de la camara
	//es el llamado de constantes del dom que se encuenta en el template (id)
	const picturePreview=$('#picture-preview');
	const camaraInput=$('#camara-input');
	const cancelPicture=$('#cancelPicture');
	const shootButton=$('#shoot');
	const uploadButton=$('#uploadButton');


	//funcion para devolver los estados que tenian anteriormente los botones y etiquetas de html en el template
	function reset(){
		picturePreview.addClass('hide');
	    cancelPicture.addClass('hide');
	    uploadButton.addClass('hide');
	    shootButton.removeClass('hide');
	    camaraInput.removeClass('hide');
	}

	//cuando se oprima el cancel picture se resetea
	cancelPicture.click(reset);

	//Agregar o llamar el disparador y llamar al dom que tenga la clase y abra el modal
	$('.modal-trigger').leanModal({
		ready:function(){
			Webcam.attach('#camara-input');
			//cuando se haga click al boton de tomar foto
			shootButton.click((ev)=>{
				Webcam.snap( function(data_uri) {
					//cambiar la propiedad de picture preview agregando un enlace que debe ser en el estilo de ecmascript 2015 (literal strings)
					//los demas son los botones que se habia asignado en el template para la funcionalidad
					//remove class (Quita la clase de hide), addClass (le pone la clase hide)
	        		picturePreview.html (`<img src="${data_uri}"/>`);
	        		picturePreview.removeClass('hide');
	        		cancelPicture.removeClass('hide');
	        		uploadButton.removeClass('hide');
	        		shootButton.addClass('hide');
	        		camaraInput.addClass('hide');
	        		//quitar las funcionalidades de click usadas antereriormente en shoot y uploadbutton
	        		uploadButton.off('click')
	        		//funciona anonima en el boton de upload boton
	        		//se le pasara un objeto tipo JSON con los datos de una picture card definida anteriormente
	        		uploadButton.click(()=> {
	        			const pic={
	        				user:{
								username:'Soberanis_Car',
								avatar:'https://scontent-dfw1-1.xx.fbcdn.net/v/t1.0-9/12540888_10201196251264580_4577950889139395794_n.jpg?oh=d026ae60ab21ca7c721954d1a03adf8d&oe=5808AC6E'
							},
							url:data_uri,
							likes:0,
							liked:false,
							createdAt: +new Date()
						}

						//definir el uso de id de pircture-cards y agregarle el picture para hacer el map en el template
						//prepend sirve para que vaya de primero en el array
						$('#picture-cards').prepend(picture(pic));
						$('#modalCamara').closeModal(Webcam.reset());
						reset();
	        		})
    			})
			})
		},
		complete:function(){
			Webcam.reset();
			reset();
		}
	})
})

// en un callback como buena practica es necesario llamar primero el error
//carga de imagenes con superagent
function loadPictures(ctx, next){
	request
		.get('/api/pictures')
		.end(function(err, res){
			if(err) return console.log(err);
			//va a contener lo que nos envia el servidor en este caso las picture
			//ponerle a context, se encarga de compartir datos a traves de los middlewares, es el request que se hace en el lado del cliente 
			ctx.pictures=res.body;																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																								
			//next es para llamar el siguiente middleware
			next();
		})
}
//recibe un monton de funciones middlewares(cedena de funciones)
//recibe el parametro next para ejecutar la siguiente funcion
//page('/',)

//carga de las imagenes con axios mediante promesas
//superagent tiene body axios tiene data
function loadPicturesAxios(ctx, next){
	axios
		.get('/api/pictures')
		.then (function(res){
			ctx.pictures=res.data;
			next();
		})
		.catch(function(err){
			console.log(err);
		})

}

//carga de datos con fetch APi
//devuelve los datos que devuelve elservidor y lo convierte a json
//ya despues se manejan los datos mediante otra promesa
function loadPicturesFetch(ctx, next){
	fetch('api/pictures')
	.then(function (res){
		return res.json();
	})
	.then(function(pictures){
		ctx.pictures=pictures;
		next();
	})
	.catch(function(err){
		console.log(err);
	})
}

//codigo asyncronico aync/wait
async function asyncLoad(ctx,next){
	try{
		//devolucion de una promesa
		//todo esto mediante el uso de emascript 2016
		//para esto se necesita de varios plugin de babel para procesar emascript 2015-2016
		ctx.pictures = await fetch('api/pictures').then(res=>res.json());
		next();
	}catch(err){
		return console.log(err);
	}
}